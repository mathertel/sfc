function u(t){let e=[],s;for(;t.length>0;)if(s=t.match(/^[./\\]/))t=t.substring(s[0].length);else if(s=t.match(/^[a-zA-Z_$][a-zA-Z0-9_$-]*/))e.push(s[0]),t=t.substring(s[0].length);else if(s=t.match(/^\d+/))e.push(Number(s[0])),t=t.substring(s[0].length);else if(s=t.match(/^\[(?<index>\d+)\]/))s.groups?.index&&e.push(Number(s.groups?.index)),t=t.substring(s[0].length);else if(s=t.match(/^\[['"]?(?<ident>[a-zA-Z_$][a-zA-Z0-9_$-]*)['"]?\]/))s.groups?.ident&&e.push(s.groups?.ident),t=t.substring(s[0].length);else throw new Error(`Invalid path syntax at '${t}'`);return e}function l(t,e,s=!1){let i,a={pathKeys:[""],pathNodes:[t]};if(e)typeof e=="string"?i=u(e):i=e;else return a;for(let n of i){if(!t[n])if(s)t[n]={};else throw new Error(`Node not found '${e}'`);a.pathKeys.push(n),a.pathNodes.push(t[n]),t=t[n]}return a}function d(t,e,s){function i(a){let n=a.pathNodes.at(-1);if(typeof n=="object")for(let r in n)a.pathKeys.push(r),a.pathNodes.push(n[r]),i(a),a.pathKeys.pop(),a.pathNodes.pop();s(a.pathKeys.join(".").substring(1),n)}i(l(t,e,!0))}function h(t,e,s){let i=!1,a=t.pathKeys.length;if(typeof e!="object"){let n=t.pathNodes[a-2],r=t.pathKeys[a-1];e==null?(delete n[r],i=!0):n[r]!==e&&(t.pathNodes[a-1]=n[r]=e,i=!0)}else for(let n in e)if(Object.prototype.hasOwnProperty.call(e,n)){let r=!1,o=e[n];if(typeof n=="string"&&(n=n.toLowerCase()),t.pathKeys.push(n),t.pathNodes.push(t.pathNodes[a-1][n]),typeof o!="object")h(t,o,s)&&(r=!0);else{let p=t.pathNodes[a-1];p[n]||(p[n]=Array.isArray(o)?[]:{},t.pathNodes[a]=p[n],r||=!0),h(t,o,s)&&(r=!0)}r&&(s(t.pathKeys.join(".").substring(1),t.pathNodes[a]),i=!0),t.pathKeys.pop(),t.pathNodes.pop()}return i}var c=class{#t=new Set;#i=0;#e={};#s=void 0;#n;constructor(e,s){this.clear(),e&&this.configurePersistence(e,s)}clear(){this.#t.clear(),this.#i=0,this.#e={}}configurePersistence(e,s="datahub"){if(!e||typeof e.setItem!="function")throw new Error("Invalid storage object. Must implement the Storage interface.");this.#s=e,this.#n=s||"datahub";let i=this.#s.getItem(this.#n);if(i)try{this.#e=JSON.parse(i)}catch{}}get(e){try{return l(this.#e,e,!1).pathNodes.at(-1)}catch{return}}#a(e,s){this.#t.forEach(i=>{e.match(i.match)&&i.callback(e,s)})}subscribe(e,s){let i=this.#i++,a=e.toLocaleLowerCase();a=a.replace("/","."),a[0]==="."&&(a=a.substring(1));let n="^"+a.replace(/\*\*/g,"[A-Za-z0-9._-]{0,}").replace(/\*/g,"[^.]*")+"$",r={id:i,match:RegExp(n),callback:s};return this.#t.add(r),i}unsubscribe(e){this.#t.forEach(s=>{s.id===e&&this.#t.delete(s)})}replay(e){d(this.#e,e,(s,i)=>{this.#a(s,i)})}publish(e,s){let i=l(this.#e,e,!0),a=h(i,s,this.#a.bind(this));for(;a&&i.pathKeys.length>0;){let n=i.pathKeys.join(".").substring(1);this.#a(n,i.pathNodes.at(-1)),i.pathKeys.pop(),i.pathNodes.pop()}if(this.#s)try{let n=JSON.stringify(this.#e);this.#s.setItem(this.#n,n)}catch{}}static tokenizePath(e){return u(e)}};window.datahub=new c;export{c as DataHub};
