var f=/^\.?(?<ident>[a-zA-Z_$][a-zA-Z0-9_$-]*)|\[(?<index>\d+)\]|\[(?<q>['"])(?<prop>.*)\k<q>\]/;function u(t){let e=[];for(;t&&t.length>0;){let s=t.match(f);if(s)s?.groups?.ident?e.push(s.groups.ident):s?.groups?.index?e.push(Number(s.groups.index)):s?.groups?.prop&&e.push(s.groups.prop);else throw new Error(`Invalid path syntax at '${t}'`);t=t.substring(s[0].length)}return e}function h(t,e,s=!1){let n,i={pathKeys:[""],pathNodes:[t]};if(e)typeof e=="string"?(e=e.replace(/\//g,"."),n=u(e)):n=e;else return i;for(let a of n){if(!t[a])if(s)t[a]={};else throw new Error(`Node not found '${e}'`);i.pathKeys.push(a),i.pathNodes.push(t[a]),t=t[a]}return i}function c(t,e,s){function n(i){let a=i.pathNodes.at(-1);if(typeof a=="object")for(let o in a)i.pathKeys.push(o),i.pathNodes.push(a[o]),n(i),i.pathKeys.pop(),i.pathNodes.pop();s(i.pathKeys.join(".").substring(1),a)}n(h(t,e,!0))}function p(t,e,s){let n=!1,i=t.pathKeys.length;if(typeof e!="object"){let a=t.pathNodes[i-2],o=t.pathKeys[i-1];e==null?(delete a[o],n=!0):a[o]!==e&&(t.pathNodes[i-1]=a[o]=e,n=!0)}else for(let a in e)if(Object.prototype.hasOwnProperty.call(e,a)){let o=!1,r=e[a];if(typeof a=="string"&&(a=a.toLowerCase()),t.pathKeys.push(a),t.pathNodes.push(t.pathNodes[i-1][a]),typeof r!="object")p(t,r,s)&&(o=!0);else{let l=t.pathNodes[i-1];l[a]||(l[a]=Array.isArray(r)?[]:{},t.pathNodes[i]=l[a],o||=!0),p(t,r,s)&&(o=!0)}o&&(s(t.pathKeys.join(".").substring(1),t.pathNodes[i]),n=!0),t.pathKeys.pop(),t.pathNodes.pop()}return n}var y=class{#e=new Set;#s=0;_store={};get(e){try{return h(this._store,e,!1).pathNodes.at(-1)}catch{return}}#t(e,s){this.#e.forEach(n=>{e.match(n.match)&&n.callback(e,s)})}subscribe(e,s){let n=this.#s++,a="^"+e.toLocaleLowerCase().replace(/\*\*/g,"[A-Za-z0-9._-]{0,}").replace(/\*/g,"[^.]*")+"$",o={id:n,match:RegExp(a),callback:s};return this.#e.add(o),n}unsubscribe(e){this.#e.forEach(s=>{s.id===e&&this.#e.delete(s)})}replay(e){c(this._store,e,(s,n)=>{this.#t(s,n)})}publish(e,s){let n=h(this._store,e,!0),i=p(n,s,this.#t.bind(this));for(;i&&n.pathKeys.length>0;){let a=n.pathKeys.join(".").substring(1);this.#t(a,n.pathNodes.at(-1)),n.pathKeys.pop(),n.pathNodes.pop()}}};window.datahub=new y;export{y as DataHub};
