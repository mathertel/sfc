var d=/^\.?(?<ident>[a-zA-Z_$][a-zA-Z0-9_$-]*)|\[(?<index>\d+)\]|\[(?<q>['"])(?<prop>.*)\k<q>\]/;function y(s){let e=[];for(;s&&s.length>0;){let t=s.match(d);if(t)t?.groups?.ident?e.push(t.groups.ident):t?.groups?.index?e.push(Number(t.groups.index)):t?.groups?.prop&&e.push(t.groups.prop);else throw new Error(`Invalid path syntax at '${s}'`);s=s.substring(t[0].length)}return e}function p(s,e,t=!1){let a,o={pathKeys:[""],pathNodes:[s]};if(e)typeof e=="string"?(e=e.replace(/\//g,"."),a=y(e)):a=e;else return o;for(let n of a){if(!s[n])if(t)s[n]={};else throw new Error(`Node not found '${e}'`);o.pathKeys.push(n),o.pathNodes.push(s[n]),s=s[n]}return o}function u(s,e,t){function a(o){let n=o.pathNodes.at(-1);if(typeof n=="object")for(let i in n)o.pathKeys.push(i),o.pathNodes.push(n[i]),a(o),o.pathKeys.pop(),o.pathNodes.pop();t(o.pathKeys.join(".").substring(1),n)}a(p(s,e,!0))}function h(s,e,t){let a=!1,o=s.pathKeys.length;if(typeof e!="object"){let n=s.pathNodes[o-2],i=s.pathKeys[o-1];e==null?(delete n[i],a=!0):n[i]!==e&&(s.pathNodes[o-1]=n[i]=e,a=!0)}else for(let n in e)if(Object.prototype.hasOwnProperty.call(e,n)){let i=!1,r=e[n];if(typeof n=="string"&&(n=n.toLowerCase()),s.pathKeys.push(n),s.pathNodes.push(s.pathNodes[o-1][n]),typeof r!="object")h(s,r,t)&&(i=!0);else{let l=s.pathNodes[o-1];l[n]||(l[n]=Array.isArray(r)?[]:{},s.pathNodes[o]=l[n],i||=!0),h(s,r,t)&&(i=!0)}i&&(t(s.pathKeys.join(".").substring(1),s.pathNodes[o]),a=!0),s.pathKeys.pop(),s.pathNodes.pop()}return a}var c=class{#t=new Set;#o=0;#e={};#s=void 0;#n;constructor(e,t){e&&this.configurePersistence(e,t)}configurePersistence(e,t="datahub"){if(!e||typeof e.setItem!="function")throw new Error("Invalid storage object. Must implement the Storage interface.");this.#s=e,this.#n=t||"datahub";let a=this.#s.getItem(this.#n);if(a)try{this.#e=JSON.parse(a)}catch{}}get(e){try{return p(this.#e,e,!1).pathNodes.at(-1)}catch{return}}#a(e,t){this.#t.forEach(a=>{e.match(a.match)&&a.callback(e,t)})}subscribe(e,t){let a=this.#o++,n="^"+e.toLocaleLowerCase().replace(/\*\*/g,"[A-Za-z0-9._-]{0,}").replace(/\*/g,"[^.]*")+"$",i={id:a,match:RegExp(n),callback:t};return this.#t.add(i),a}unsubscribe(e){this.#t.forEach(t=>{t.id===e&&this.#t.delete(t)})}replay(e){u(this.#e,e,(t,a)=>{this.#a(t,a)})}publish(e,t){let a=p(this.#e,e,!0),o=h(a,t,this.#a.bind(this));for(;o&&a.pathKeys.length>0;){let n=a.pathKeys.join(".").substring(1);this.#a(n,a.pathNodes.at(-1)),a.pathKeys.pop(),a.pathNodes.pop()}if(this.#s)try{let n=JSON.stringify(this.#e);this.#s.setItem(this.#n,n)}catch{}}};window.datahub=new c;export{c as DataHub};
