function c(s){let e=[],t;for(;s.length>0;){if(!(t=s.match(/^[./\\]/)))if(t=s.match(/^[a-zA-Z_$][a-zA-Z0-9_$-]*/))e.push(t[0]);else if(t=s.match(/^\d+/))e.push(Number(t[0]));else if(t=s.match(/^\[(?<index>\d+)\]/))t.groups?.index&&e.push(Number(t.groups?.index));else if(t=s.match(/^\[['"]?(?<ident>[a-zA-Z_$][a-zA-Z0-9_$-]*)['"]?\]/))t.groups?.ident&&e.push(t.groups?.ident);else if(t=s.match(/^[*]{1,2}/))e.push(t[0]);else throw new Error(`Invalid path syntax at '${s}'`);t&&(s=s.substring(t[0].length))}return e}function p(s,e,t=!1){let n,i={pathKeys:[""],pathNodes:[s]};if(e)typeof e=="string"?n=c(e):n=e;else return i;for(let a of n){if(!s[a])if(t)s[a]={};else throw new Error(`Node not found '${e}'`);i.pathKeys.push(a),i.pathNodes.push(s[a]),s=s[a]}return i}function f(s,e,t){function n(i){let a=i.pathNodes.at(-1);if(typeof a=="object")for(let o in a)i.pathKeys.push(o),i.pathNodes.push(a[o]),n(i),i.pathKeys.pop(),i.pathNodes.pop();t(i.pathKeys.join(".").substring(1),a)}n(p(s,e,!0))}function h(s,e,t){let n=!1,i=s.pathKeys.length;if(typeof e!="object"){let a=s.pathNodes[i-2],o=s.pathKeys[i-1];e==null?(delete a[o],n=!0):a[o]!==e&&(s.pathNodes[i-1]=a[o]=e,n=!0)}else for(let a in e)if(Object.prototype.hasOwnProperty.call(e,a)){let o=!1,r=e[a];if(typeof a=="string"&&(a=a.toLowerCase()),s.pathKeys.push(a),s.pathNodes.push(s.pathNodes[i-1][a]),typeof r!="object")h(s,r,t)&&(o=!0);else{let l=s.pathNodes[i-1];l[a]||(l[a]=Array.isArray(r)?[]:{},s.pathNodes[i]=l[a],o||=!0),h(s,r,t)&&(o=!0)}o&&(t(s.pathKeys.join(".").substring(1),s.pathNodes[i]),n=!0),s.pathKeys.pop(),s.pathNodes.pop()}return n}var u=class{#t=new Set;#i=0;#e={};#s=void 0;#n;constructor(e,t){this.clear(),e&&this.configurePersistence(e,t)}clear(){this.#t.clear(),this.#i=0,this.#e={}}configurePersistence(e,t="datahub"){if(!e||typeof e.setItem!="function")throw new Error("Invalid storage object. Must implement the Storage interface.");this.#s=e,this.#n=t||"datahub";let n=this.#s.getItem(this.#n);if(n)try{this.#e=JSON.parse(n)}catch{}}get(e){try{return p(this.#e,e,!1).pathNodes.at(-1)}catch{return}}#a(e,t){this.#t.forEach(n=>{e.match(n.match)&&n.callback(e,t)})}subscribe(e,t){let n=this.#i++,i=e.toLocaleLowerCase();i=i.replace("/","."),i[0]==="."&&(i=i.substring(1));let a="^"+i.replace(/\*\*/g,"[A-Za-z0-9._-]{0,}").replace(/\*/g,"[^.]*")+"$",o={id:n,match:RegExp(a),callback:t};return this.#t.add(o),n}unsubscribe(e){this.#t.forEach(t=>{t.id===e&&this.#t.delete(t)})}replay(e){f(this.#e,e,(t,n)=>{this.#a(t,n)})}publish(e,t){let n=p(this.#e,e,!0),i=h(n,t,this.#a.bind(this));if(i&&n.pathKeys.length>0&&!t){let a=n.pathKeys.join(".").substring(1);this.#a(a,void 0),n.pathKeys.pop(),n.pathNodes.pop()}for(;i&&n.pathKeys.length>0;){let a=n.pathKeys.join(".").substring(1);this.#a(a,n.pathNodes.at(-1)),n.pathKeys.pop(),n.pathNodes.pop()}if(this.#s)try{let a=JSON.stringify(this.#e);this.#s.setItem(this.#n,a)}catch{}}static tokenizePath(e){return c(e)}};window.datahub=new u;export{u as DataHub};
